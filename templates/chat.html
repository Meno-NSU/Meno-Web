<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>RAG-–ß–∞—Ç</title>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<header class="topbar">
    <img src="/static/meno-icon.jpg" alt="–ò–∫–æ–Ω–∫–∞" class="topbar-icon">
    <span class="topbar-title">–ú–µ–Ω–æ–Ω</span>
    <form
            hx-post="/clear"
            hx-target="#messages"
            hx-swap="innerHTML"
            class="clear-form-header"
            style="margin-left:auto;">
        <button type="submit" class="clear-btn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </form>
</header>
<div class="container">
    <div class="chat">
        <div id="messages" class="messages" hx-target="this" hx-swap="innerHTML">
            {% include "components/messages.html" %}
        </div>
    </div>
</div>
<!--<button id="scroll-down-btn" class="scroll-down-btn" onclick="scrollToBottom()">‚ñº</button>-->
<script>
    const scrollBtn = document.getElementById('scroll-down-btn');
    const messages = document.getElementById('messages');

    function scrollToBottom() {
        messages.scrollTop = messages.scrollHeight;
    }

    // –°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ
    messages.addEventListener('scroll', () => {
        const delta = messages.scrollHeight - messages.scrollTop - messages.clientHeight;
        scrollBtn.style.display = delta > 50 ? 'block' : 'none';
    });

    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', scrollToBottom);

    // –ê–≤—Ç–æ—Å–∫—Ä–æ–ª–ª –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ htmx
    document.body.addEventListener("htmx:afterSwap", (e) => {
        if (e.target.id === "messages") {
            scrollToBottom();
        }
    });
</script>
<div class="input-area">
    <form class="input-bar"
          id="chat-form"
          autocomplete="off">
        <input type="text" name="message" id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required autocomplete="off">
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
</div>
<script>
    const form = document.getElementById('chat-form');
    const input = document.getElementById('input');
    const messagesDiv = document.getElementById('messages');

    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const userMessage = input.value.trim();
        if (!userMessage) return;

        // –î–æ–±–∞–≤–∏—Ç—å bubble –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const userDiv = document.createElement('div');
        userDiv.className = 'msg-user';
        userDiv.innerHTML = `<div class='msg-bubble user'>${escapeHtml(userMessage)}</div>`;
        messagesDiv.appendChild(userDiv);

        // –î–æ–±–∞–≤–∏—Ç—å bubble –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'msg-assistant loading-message';
        loadingDiv.id = 'loading-indicator';
        loadingDiv.innerHTML = `<div class='msg-plain'><span class='loading-dots'>–ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç<span class='dot'>.</span><span class='dot'>.</span><span class='dot'>.</span></span></div>`;
        messagesDiv.appendChild(loadingDiv);

        scrollToBottom();
        input.value = '';
        input.focus();

        let responseHtml = '';
        try {
            const data = new FormData();
            data.append('message', userMessage);
            const resp = await fetch('/send', {
                method: 'POST',
                body: data,
            });
            responseHtml = await resp.text();
            console.log("HTTP —Å—Ç–∞—Ç—É—Å:", resp.status);
            console.log("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", responseHtml);
            if (!resp.ok || !responseHtml.trim()) {
                responseHtml = `<div class='msg-assistant'><div class='msg-plain error'>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div></div>`;
            }
        } catch (e) {
            // –¢—É—Ç –≤–∞–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å HTML bubble –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ —Å –æ—à–∏–±–∫–æ–π
            responseHtml = `<div class='msg-assistant'><div class='msg-plain error'>[–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º]</div></div>`;
        }

        // –í—Å–µ–≥–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–º–µ–Ω—É –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
        const loadingDivCurrent = document.getElementById('loading-indicator');
        if (loadingDivCurrent) {
            let errorMode = false;
            let htmlToInsert = "";

            if (typeof responseHtml === "undefined" || responseHtml === null || !responseHtml.trim()) {
                // –≠—Ç–æ –ª–∏–±–æ –±–ª–æ–∫ catch, –ª–∏–±–æ –æ—Ç–≤–µ—Ç –ø—É—Å—Ç–æ–π ‚Äî —Å—á–∏—Ç–∞–µ–º –æ—à–∏–±–∫–æ–π
                errorMode = true;
                htmlToInsert = "<div class='msg-assistant'><div class='msg-plain error'>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div></div>";
            } else {
                htmlToInsert = responseHtml;
            }

            // –ü–∞—Ä—Å–∏–º htmlToInsert
            const temp = document.createElement('div');
            temp.innerHTML = htmlToInsert;
            const nodes = Array.from(temp.childNodes).filter(n => n.nodeType === 1 || (n.nodeType === 3 && n.textContent.trim() !== ""));
            if (nodes.length) {
                // –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∑–∞–º–µ–Ω—è–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                messagesDiv.replaceChild(nodes[0], loadingDivCurrent);
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å) –¥–æ–±–∞–≤–ª—è–µ–º
                for (let i = 1; i < nodes.length; i++) {
                    messagesDiv.appendChild(nodes[i]);
                }
            } else {
                // –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, –µ—Å–ª–∏ htmlToInsert –±—ã–ª —Å–æ–≤—Å–µ–º –ø—É—Å—Ç–æ–π (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ)
                loadingDivCurrent.outerHTML = "<div class='msg-assistant'><div class='msg-plain error'>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —Å–∏—Å—Ç–µ–º–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</div></div>";
            }
        }
        scrollToBottom();
    });

    // Escape XSS (–≤–∞–∂–Ω–æ!)
    function escapeHtml(unsafe) {
        return unsafe.replace(/[&<"'>]/g, function (m) {
            switch (m) {
                case '&':
                    return "&amp;";
                case '<':
                    return "&lt;";
                case '>':
                    return "&gt;";
                case '"':
                    return "&quot;";
                case "'":
                    return "&#039;";
            }
        });
    }

    // –∞–Ω–∏–º–∞—Ü–∏—è —Ç–æ—á–µ–∫
    setInterval(() => {
        document.querySelectorAll('.loading-dots').forEach(el => {
            const now = el.textContent.replace(/\.{1,3}$/, '');
            if (!el.dataset.dots) el.dataset.dots = '.';
            el.dataset.dots = (el.dataset.dots.length < 3) ? el.dataset.dots + '.' : '.';
            el.textContent = "–ì–µ–Ω–µ—Ä–∏—Ä—É—é –æ—Ç–≤–µ—Ç" + el.dataset.dots;
        });
    }, 400);
</script>
</body>
</html>
